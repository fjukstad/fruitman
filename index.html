<!DOCTYPE html>
<meta charset="utf-8" /> 
<meta name="viewport" content="width=device-width, heigth=device-height" >

<script src="d3.js"></script>
<script src="jquery-2.1.4.js"></script>

<style>
body { 
    margin-top:0px;
    font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", 
      Helvetica, Arial, "Lucida Grande", sans-serif;

    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;

}

img.top-logo{ 
    height: 20em;
    max-height: 18%;
    padding-top: 0em;
    float:left;
    transform: translateX(-1em)

}

img.bottom-logo{
    max-height: 8%; 
    float: right;
    padding-right: 1em;
    position: absolute;
    bottom: 1em;
    right: 0;
}

div {
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    bottom 0;
}

h1 {
    font-size: 5em;
    text-align: center;
    /* color: #de7c00;  */
}

h2 { 
    text-align: center
}
svg.barchart { 
    
    display:block;
    margin-left: auto;
    margin-right: auto;

}

</style> 

<div> 
<img src="top.png" class="top-logo">
<h1>  Stem på din favoritt! </h1>
<svg class="barchart"></svg> 

<script>

    var fruits = []; 
    var fruitMap = {}; 

    var f = ["eple", "drue", "banan", "appelsin", "pære", "mango", "melon"]
    var color = [ "#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f", "#e5c494"]

    for(var i = 0; i < f.length; i++){
        fruits.push({name: f[i], score: 0})
    }

    var ok2vote = true 

    var keymap = {
            87: "melon",
            65: "eple", 
            68: "drue",
            32: "banan",
            83: "appelsin",
            70: "pære",
            71: "mango",
    }
    



    var height =  window.innerHeight/2;
    var width = window.innerWidth - 100; 
    var barwidth = width/(f.length+2);
    var barmargin = 1.3;

    var bottomMargin = 50; 
    var fontSize = width/40;

    var numVotes = 0; 

                
    var chart = d3.select(".barchart")
                    .attr("height", height)
                    .attr("width", width);

    var bar; 

    var maxScore = 0; 
    var scores = Array(f.length) 
    for(var i = 0; i < f.length; i++){
        scores[i] = 0; 
        fruitMap[f[i]] = i; 
    }


    d3.csv("results.csv")
        .row(function(d) { 
            fruit = d[Object.keys(d)[0]]
            console.log(fruits, fruit) 
            index = fruitMap[fruit];
            scores[index]++ 

        })

        .get(function(error, rows){
            update() 
        })

    function update() {

         console.log(scores)
             var maxScore = Math.max.apply(null, scores)
            
            var y = d3.scale.linear()
                    .range([0, height])
                    .domain([0, maxScore])
                        
            // update   
            bar = chart.selectAll("g")
                        .data(scores);

            bar.attr("transform", function(d,i){
                var h = height - y(d) - bottomMargin
                var w = i*barwidth*barmargin; 
                return "translate("+w+","+h+")";
            }); 

            bar.select("rect")
                .attr("height", function(d){
                        return y(d) 
                })
            bar.select("text")
                .attr("transform", function(d,i){
                    ytrans = y(d) + fontSize;
                    return "translate(0,"+ ytrans + ")"
                }) 
                .text(function(d,i){
                    return f[i] + " (" + scores[i] + ")";
                })
                        
            barEnter = bar.enter()
                .append("g")
                .attr("transform", function(d,i){
                    var h = height - y(d) - bottomMargin
                    var w = i*barwidth*barmargin; 
                    return "translate("+w+","+h+")";
                }); 
            

            barEnter.append("rect")
                .attr("width", barwidth)
                .attr("height", function(d){
                    return y(d) - bottomMargin
                })
                .style("fill", function(d,i){
                        return color[i];
                        });
            
            barEnter.append("text")
                .attr("transform", function(d,i){
                    ytrans = y(d) + fontSize
                    return "translate("+barwidth/5+","+ytrans+")"
                }) 
                .style("font-size", fontSize)
                .text(function(d,i){
                    return f[i] + " (" + scores[i] + ")";
                })

            bar.exit().remove()


    }

    d3.select("body")
        .on("keydown", function(){

                if(!ok2vote) { 
                    return 
                }

                numVotes ++; 
                console.log(d3.event.keyCode)
                fruit = keymap[d3.event.keyCode]
                console.log(fruit)
                if(typeof fruit != "undefined"){
                    $.post("/submit/", {fruit:fruit}); 
                    index = fruitMap[fruit];
                    scores[index]++ 
                }

                ok2vote = false 

                d3.selectAll("h1")
                    .text("Takk for din stemme!") 

                d3.selectAll("h2")
                    .text("Totalt "+numVotes+" stemmer") 
                    
                setTimeout(function(){
                    d3.selectAll("h1")
                        .text("Stem på din favoritt!") 
                    ok2vote=true;


                }, 2000)  

                update() 
            }); 

</script>

<h2> Totalt 0 stemmer </h2> 
<img src="bottom.png" class="bottom-logo">
</div> 
